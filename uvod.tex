\chap Úvod

aaaaa

\sec Aktualni stav problematiky

\label[USB]

\chap Universal Serial Bus


Universal Serial Bus (USB) je standart vyvyjeny od roku 1994 pro pripojeni periferii k pocitaci.
Byla vytvorena aby nahradila pomale a ruzne sbernice serail, paralel, keyboard s jednou sbernici.
USB melo nahradit seriove a paralerni porty a vsak v soucasne dobe nahrazuje take PS/2, audio, video a take umoznuje prenaset ethernetove ramce.
USB se rozrostlo a nyni podporuje skoro kazdy druh zarizeni \cite[LDD3].
Topologicky neni usb subsystem polozen jako sbernice, ael spise strom slozeny z point-to-point linek.S jednim mastrem na sberici.
Linky jsou 4 dratove - zem, napeti, D+ and D-. Ktere pripojuji zarizeni a HUBY. USB controller je ve veleni a pta se kazdeho usb jestli nema neco na odelani. Diky topologii nemuze usb vysilat aniz by bylo dotazano na data. A proto umoznuji jednoduchy plug-and-play susbsystem, ktery je rizen a configurovan automaticky host computer.

USB je asymetricka topoligii pripojena do hvezdicove topologie - konkretne stromu. Pricemz USB huby vytvareji jednotlive uzly tohoto stromu a zarizeni tvori jejich listy. Maximalni hloubka toho stromu je 5 a k usb muze mit maximalne 127 zarizeni.
USB komunikace je zalozena na logickych kanalech tzv. pipes. Kazdemu vystupnimu kanalu by mel odpovidat jeden vstupni.
USB muze mit maximalne 30 endpointu. Tyto endpointy jsou inicializovany v prubehu enumarace USB zarizeni, ktere probiha po kontrolnim kanalu 0, ktery maji vsechna zarizeni.
Krome kontrolniho prenosu existuje izochroni, prerusovany a blokovy prenos.

\begitems
*Kontrolni - Slouzi ke konfiguraci zarizeni. Kazde zarizeni disponuje timto endpointem. Tento endpoint slouzi k enumeraci
*Izochroni - Slouzi  ke stalemu prenosu vetsich dat. Je garantovana latence, ale neni garantovao doruceni. Velmi vhodne pro audio a video.
*Prerusovany - urceny pro caste prenosy maleho mnozstvi dat. Garantovano doruceni a sircka pasma. Je defonovano maximalni zpozdeni
*Blokovy - je urcen pro prenos velkeho mnozstvi dat, ale nezarucuje pasmo ci latenci(prenos dat) viz prednaska Novaka
\enditems

Enumerace je posloupnost standardizovanych prikazu, ktery zapocal host. V prubehu enumerace se predavani tzv. deskriptory. Ktere obsahuji tyto dulezite informace o zarizeni. Na zaklade informace v deskriptorech se na zarizeni pouzije specialni ovladac.
Tento standart se v soucasne dobe rozvinul u umoznuje pripojit temer jakekoli zarizeni. Jako jsou ukazovaci zarizeni, pametova zarizeni, tiskarny, komunikacni zarizeni a mnohe dalsi.
Tato zarizeni jsou roztrizena do trid z dovodu s jednoceni druhu chovani jako jsou HID, PID Printer, Mass Storage a mnohe dalsi.
Toto sjednocene chovani ma za dusledek spolecnych ovladacu, ktera tato zarizeni mohou vyuzivat.
A vsak nektera z techto zarizeni se do techto trid nevnestnaji ci maji rozsirene chovani a potrebuji specailni pristup.

%LDD3 pekny popis zarizeni http://www.makelinux.net/ldd3/?u=chp-13-sect-4


\label[MII]

\chap Media Independent Interface

Media Independent Interface (MII) je specifikovano standardem IEEE 802.3 v kapitole 22. Interface je nezavysli na procesoru a fyzickem mediu.
MII propojuje dve vrstvy ISO/OSI a to vrstvu Data Link, konkretne jeji cast Medai Access Constroll (MAC) a vrstvou fyzickou (PHY).
MII obsahuje dva druhy sbernic a to datovou a manezovaci.
Menagement Data Input/Output (MDIO) Serial Management Interface (SMI) se používá k nastovování mezi MAC a PHY.

\medskip
\clabel[MIItoISO]{Spojitost mezi MII a OSI/OSI}
%\picw=13cm \cinspic MIItoISO.png
\picw=6cm \cinspic a.png
\caption/f Obrazek popisuje spojistost mezi rozhranim MII, modelem OSO/OSI a modelem IEEE 802.3 CSMA/CD LAN \cite[IEEE8023].
\medskip

Na oprazku \ref[MIItoISO] muzeme videt pripojeni MII inerface na Reconciliation Sublayer (RS) a PCS/PLS. RS je podvrstva, ktera mapuje signali z MII na MAC/PLS obsluhu. Mapovani techto signalu muzeme videt na obrazku \ref[RStoMII]. PLS/PLC vrstvy, ktere se staraji o kodovani signalu.

%asi zbytecny detaili
\medskip
\clabel[RStoMII]{Mapovani signalu RS to MII}
%\picw=13cm \cinspic MIItoISO.png
\picw=6cm \cinspic a.png
\caption/f Obrazek popisuje mapovani signalu mezi RS vstupem a vystupem a STA v MII \cite[IEEE8023].
\medskip

Az 32 PHY jednotek muze byt obsluhovano jednim manazovacim  MII rozhranim.
MII podporuje dva datove toky a to je 10~Mb/s a 100~Mb/s. Funkcionalita je identicka na oboch datovych tokach a lisi se poze v nominalni frakvenci hodin.

\sec Fyzicke rozhrani MII

MII disponuje nekolika druhy signalu, ktere muzeme videt na prave strane obrazku \ref[RStoMII]. 

\begitems
*TX\_CLK -- Refenecni hodiny pro TX\_EN, TXD a TX\_ER signaly z RS do PHY. Zdrojem TX\_CLK je PHY. Frekvence hodin by mela byt 20\% z nominalniho prenosu dat +- 100ppm.
*RX\_CLK -- Refenecni hodiny pro RX\_DV, RXD a RX\_ER signaly z PHY do RS. Zdrojem RX\_CLK je PHY. RX\_CLK muze mit referenci hodnotu z prijimanych dat nebo muze byt odvozena z nominalni hodnoty jako u TX\_CLK.
*TX\_EN -- Indikace ze RS je pripravena odeslat nibble na MII.
*TDX -- je ctverice datovych signalu (TDX[3:0]) ovladana RS, ktera prenasi data synchrone na zaklade TX\_CLK. TDX[0] je nejmene vyznami bit. Pokud je TX\_EN odpojen TDX nema zadny efekt na PHY.
*TX\_ER -- synchrone na TX\_CLK a pokud je TX\_EN take nastaven. PHY by mela vyslat jeden ci vyce symbolu, ktera nejsou casti dat neb rperusit nekde v ramci.
*RX\_DV -- Prijata data jsou validni je rizen PHY a rika, ze dekodoval nibble na RXD[3:0] a je synchroni k RX\_CLK
*RXD -- je ctverice datovych signalu (RDX[3:0]) ovladane PHY. Krera slouzi k prenosu dat z PHY do RS. RXD[0] je LSB.
*RX\_ER -- Signal rizeny RHY.Ktrery indikuje RS ze nastal error detekovany nekde ve framu.  pokud je RX\_DV odpojen nema zadny vliv na RS
*CRS -- Je aktivovan pokud prijemce nebo odesilatel je zaneprazdnen. A neaktivni pokud jsou idle. Neni neni synchroni jak na TX\_EN tak na RX\_EN.v
*COL -- je vyvolan PHY pokud se na mediu nastane kolize. 
*CRS a COL -- A neaktivni pokud jsou idle. Neni neni synchroni jak na TX\_EN tak na RX\_EN. Nedefinovane chovani COL a CRS pokud bit 0.8 je aktivni. Reprezentuje pokud josu data na odeslani nebo prijeti.
*MDC -- Casova zakladna pro MDIO signal. Je aperiodicky signal, ktery nema zadne minimum a maximum, ale mel by se pohybovat od 160 do 400 ns.
*MDIO -- je obousmerny signal, proveden tristavovym obvodem, mezi PHY a STA. Pouziva se k prenosu kontrolnich zprav mezi temito zarizenimi. MDIO je synchroni s MDC a informace josu rizeny z PHY.
\enditems

Prenos dat je popsan formatem
<inter-frame><preamble><sfd><data><efd>.
Prizemz byte je rozdelen na dva nibble a odeslan po dvouch castech. Tak jak muzeme videt na obrazku X.
%popis  <inter-frame><preamble><sfd><data><efd>  ?

\medskip
\clabel[transiotionMII]{Komunikace bez kolize po MII}
%\picw=13cm \cinspic MIItoISO.png
\picw=6cm \cinspic a.png
\caption/f Obrazek ukazuje jak vypada komunikace po MII bez zadne kolize \cite[IEEE8023].
\medskip

\sec Manezovaci rozhrani a registrovy prostor

Manezovaci rozhrani je specifikovano dvou linkovym seriovym rozhranim pripojenym k menozovacim vstupum PHY pro ovladni PHY a zbirani informaci o PHY.
MII obsahuje dva zakladne sety registru Controlni a Stavovy. Vsechny PHY, ktere podporuji MII by meli zahrnovat tuto sadu registru. Stavovy a Controlni registrove prostory muzete videt v priloha X. A specifikuji zakladni vlastnosti pro 100Mb/s 1Gb/s PHYs. Registry 2-14josu casti rozsireneho regitroveho prostoru.(22.2.4 info o reg)
Format menezovacich ramcu je popsan tabulkou tab X a je odesilan z leva do prava.

\midinsert \clabel[MDIOframe]{Format menezovaciho ramce.}
\ctable{lllllllll}{
 \hfil   operace  & PRE & ST & OP & PHYAD & REGAD & TA & DATA & IDLE \crl \tskip4pt
          cteni   & 1...1 & 01 & 10 & AAAAA & RRRRR & Z0 & D...D & Z \cr
          zapis   & 1...1 & 01 & 01 & AAAAA & RRRRR & 10 & D...D & Z \cr
}
\caption/t Format menezovacich zprav odesilany z leva do prava \cite[IEEE8023] (table 22-12).
\endinsert

V tabulce \ref[MDIOframe] muzeme videt hodnotu Preambule (PRE), ktera je posloupnost 32bitu hodnoty logicke 1 slouzici k synchronizaci s MDC.
Zacatek ramce (ST) je 01. Pote nasleduje Operacni kod (OP), ktery urcuje druh operace cteni nebo zapisu. PHYAD je fyzicka adresa zarizeni o delce 5bitu tj. az 32 zarizeni. Prvni bit je MSB. Dalsi polozkouy je adresa registru (REGAD) cislovana jako vyse. Dalsim blokem je TA coz slouzi u cteni k prohozeni odesilatele, kdy se aktivni odesilatel prehodi do stavu vysoke impedance a necha vysilani PHY. Pri zapisu je vysilana logicka 1. Data jsou 16bitova hodnota.


% Ne do DP
%\sec GMII

%The Gigabit Media Independent Interface (GMII) is similar to the MII. The GMII uses the MII management interface and register set specified in 22.2.4. These common elements of operation allow Station Management to determine PHY capabilities for any supported speed of operation and configure the station based on those capabilities. In a station supporting both MII and GMII operation, configuration of the station would include enabling either the MII or GMII operation as appropriate for the data rate of the selected PHY. Most of the MII and GMII signals use the same names, but the width of the RXD and TXD data bundles and the semantics of the associated control signals differ between MII and GMII operation. The GMII transmit path clocking also differs significantly from MII clocking. MII operation of these signals and clocks is specified within Clause 22 and GMII operation is specified within Clause 35.
%GMII obsahuje 3ti zakladni registr Extended status reg(15)

\sec RMII

RMIITM Specification (Reduced MII). RMII provides independent 2-bit wide transmit and receive paths synchronised to a common 50MHz reference clock. Furthermore, carrier sense and receive data valid are now combined  as one signal CRS\_DV. Collision detection is regenerated on the MAC side by ANDing signals TX\_EN and CRS\_DV. This reduces the total pins per port to 8 from 16 (MII)

\chap HW

\sec Colibri T20

Colibri T20 je SODIMM pocitacovy modul posltaven na zaklade NVIDIA Tegra 2 embeded systemu na cipu (SOC). 
SOC modul Tegra 2 je zalozanan na dvoujadrovem procesoru Cortex A9 symmetric MPCore od firmy ARM s rychlosti okolo 1 Ghz.
Jelikoz se jedna o SOC obsahuje tento cip take mnoho mluku jako Audio/Video rekorder. Graficky cip s podporou 2D rendrovani a 3D pixel a vektor shaderem.

Cip obsahuje periferie popsane na blokovem diagramu z 
%(https://www.toradex.com/computer-on-modules/colibri-arm-family/nvidia-tegra-2).

%chtelo by to swap Colibri a ARM ci spojit...
\sec ARM Cortex A9

ARM je 32-bitove RISC architektura vyvajena spolecnosti ARM Holding venujici se vyvoji procesorovych jader.

Dvoujadrovy procesor ARM Cortex A9 symmetric MPCore je jeden z aplikacnich procesoru.

Tento procesor porporuje out-of-order a spekulaticni provadeni instrukci. 
Ma plne koheretni podporu pro symetricke procesory.
Tento modulu dosahuje velmi vysokeho grafickeho ale take vypocetniho vykonu viz. \ref[testColibriT20]. 
Procesor tez obsaguje jednotku pro vypocty s plovouci radovou carkou.

\sec Asix AX88772b

Jako jediny z vyrobnich rad dosahuje v revizi AX88772bXX ma teplotni rozsahy od -40C az +85C.

AX88772b je USB 2.0 - 10/100 Mb/s Fast Ethernet kontroler s vysokou vykonosti a intergraci ASIC, ktera umoznuje malou zpotrebu a plug-and-play Fast Ethernet internetove pripojeni pro zarizeni pouzivajici stantardyzovane USB \ref[USB].

AX88772b podporuje volitelny Multy-Function-Bus(MFA/MFB) pro externi PHY nebo externim MAC. MFA/MFB muze byt nakonfigutovano jako General purpose I/O, RMII \ref[RMII] pro implementaci Fast ethernetu nebo jako Reverse-RMII pro MAC-to-MAC pripojeni k nejakakemu MCU s ethernet MAC RMII rozhranim.
%neudelat 802.3 chap?
MAC Core podporuje 802.3 a 802.3u MAC funkce, jako je prijem a odeslani ramce, kontrolu CRC, duplex mode, forwarding, flow-control, detekce kolizi atd.

\sec Marvell 88E6065

Obsahuje  petkrat yysilac na fyzicke vrstve 10~BASE-T/100~BASE-TX, ktere muzou byt pouzity take pro optickou linku 100~BASE-FX.
Sestym portem je nezavysli Fast ethernet media access controller.
Je jedno cipovy obvod integrujici 4 + 2 portu Fast Ethernetoveho switche. Toto zarizeni podporuje Quality of Service (QoS) A vyjmecne muzou vyuzivat podpory pro routry a vychozi brany.
Zarizeni ma high-speed, non-blocking four traffic class QoS. True plag-n-play je podporovano s Auto-Crossoer, Auto-polarity a Auto-nogotiation na fyzike vrtve. Zarizeni podporuje 64 z 4096 802.1Q WLAN s 3 levlovou ochranou. Ma dve RMII/MII/SNI rozhrani, ktera mohou byt pripojena k menezovacimu rozhrani nebo Router CPU s integrovanou MAC.

MAC a PHY rozhrani jsou plne kompatibilni se standardy IEEE~802.3, IEEE~802.3u a IEEE~802.3x.
Zarizeni muze byt configurovano prez STA (SNI) nebo moze nastaveni nacitat z flash.


\chap SW

\sec linux

\sec Co to je Ovladac?

Ovladac je kus programu ktery operuje nebo controluje urcite zarizeni pripojene k pocitaci. Ovladace vytvareni softwareove rozhrani pro hardwarove zarizeni, ktere umoznuji operacnimu systemy ovladat tento hardware aniz by vedel jak presne funguje.

Ovladace zarizeni maji v linuxu specialni roly \ref[LDD3]. Tyto kusy kodu umoznuji HW aby odpovidal definovanym rozhranim.


\sec info kernel

\sec loading proces

\sec disribuce

\secc openwrt

\sec linux sub

\secc miibus

\secc device

At the lowest level, every device in a Linux system is represented by an instance of struct device. The device structure contains the information that the device model core needs to model the system. Most subsystems, however, track additional information about the devices they host. As a result, it is rare for devices to be represented by bare device structures; instead, that structure, like kobject structures, is usually embedded within a higher-level representation of the device \ref[DEV].

\secc Distributed Switch Architecture

 Distributed Switch Architecture (DSA) je protokol pro menezovani hardwarovych switchu, ktere obsahuji MII menezovaci registry a prikazy nastavujici switche a ethernotovy format ktery signalizuje, na kterm portu apyl paket prijet nebo ktery se hodla odelsat \ref[DSA].
Tento driver podporuje swtihe, ktere jsou pripojeny zpusobem:

%+-----------+       +-----------+ \hfill \break
%|           | RGMII |           |
%|           +-------+           +------ 1000baseT MDI ("WAN")
%|           |       |  6-port   +------ 1000baseT MDI ("LAN1")
%|    CPU    |       |  ethernet +------ 1000baseT MDI ("LAN2")
%|           |MIImgmt|  switch   +------ 1000baseT MDI ("LAN3")
%|           +-------+  w/5 PHYs +------ 1000baseT MDI ("LAN4")
%|           |       |           |
%+-----------+       +-----------+

Tento switch driver reprezentuje kazdy port jako oddeleny sitove rozhrani. Pollovani, stav portu, MII manazement interfacu je proveden diky ethtoolu.


DSA podporuje i propojeni mezi switchy, ktere pak muzem take ovladat.

%        +-----+          +--------+       +--------+
%        |     |eth0    10| switch |9    10| switch |
%        | CPU +----------+        +-------+        |
%        |     |          | chip 0 |       | chip 1 |
%        +-----+          +---++---+       +---++---+
%                             ||               ||
%                             ||               ||
%                             ||1000baseT      ||1000baseT
%                             ||ports 1-8      ||ports 9-16





\secc usb driver

Linuxove jadro podporuje dva druhy zarizeni drivers on a host system and drivers on a device \cite[LDD3]. USB ovladac na hostosky system ke kteremu je USB zarizeni pripojeno.
Ovladace na zarizeni neboli \"USB gadget drivers\" ovladini zarizeni vypadajici jako hostovska stanice pripojena prez USB.
NA obrazku nize muzeme videt USB stack. Kde USB muze zit v nekolika ruznych subsystemych (net, block, char ...). USB core dava rozhrani pro USB ovladace, kteri chteji kontrolovat a pristupovat k HW. Ruzne druhy kontroleru jsou reprezentovany v systemu.

USB endpointy jsou popsany v kernelu strukturou struct usb\_host\_endpoint a ta obsahuje informace o realnem endpintu v strukture struct usb\_endpoint\_descriptor - ten popisuje data pomoci prijmutych dekriptoru.

USB interface nekolik endpointu, ktere tvori jedno logicke pripojeni jako je mys, klavesni, video atd. Nektera USB zarizeni mohou mit vice interfacu. USB speaker ma dva interfaci jako je USB keyboear pro tlacitka a USB audio stream.%TODO presunout nahoru
Pro kazdy interface Linux pouziva jeden hardwarovy ovladac. A tento interface je popsan struktorou struct usb\_interface. Tato struktura je to co USB core dava USB driverum.
Kazde zarizeni je vazano konfiguraci a jedno USB zarizeni muze mit vice configuraci, ktera se mohou menit. A vsak Linux nemuze obsluhovat vice configuraci v jeden cas. Linux popisuje configuraci v struct usb\_host\_config a cele USB zarizeni strukturou struct usb\_device.
USB drivery obycejne prepisuji data z usb\_interafacu do struct usb\_device.

Samotny usb\_device a usb\_interface je zobrazeny v sysfs jako jednotliva zarizeni.

usb\_device:
/sys/devices/pci0000:00/0000:00:09.0/usb2/2-1

usb\_interface je pojmenovan podle formatu root\_hub-hub\_port:config.interface(pro hlubsi stromy je schema root\_hub-hub\_port-hub\_port:config.interface) :
/sys/devices/pci0000:00/0000:00:09.0/usb2/2-1/2-1:1.0

Pro komunikaci se vsemi USB zarizenimi linux pouziva USB request block (urb). Urb se pouziva k posilani a prijmu da pro specificky usb endpint a specifivcke usb zarizeni v asynchronim zpusobem.

%\secc net\_device

\secc usbnet

Usbnet je subsystem linuxoveho jadra, ktery umoznuje ovladat USB-sitove zarizeni jako je ethernet, DSL, IDSN atd \ref[USBNET].
Je to genericky USB sitovy framework, ktery pracuje na ruznych rochlostech a ruznymi protokoli. 


\secc System Filesystem

SYstem FileSystem (Sysfs) je charakteristika linuxu 2.6, ktera umozuje kernelovemu kodu exportovat informace do userspacu za pouziti pameti za pouziti VFS\ref[SYSFS]. Vetsinou kazdy file vetsinou ASCII obsahuje pouze jednu hodnotu.
Hlavnim ucelem je reprezentovat objekty, jejich atributy a jejich vstahy navzajem.
Poskytuje dve slozky:
*kernel programing interface -- pro export itemu skrz sysfs
*user interface -- k videni a manipulaci techto itemu, ktere mapuje zpet na objekty v kernelu
Mapovani mezi objekty muzeme videt v \ref[SYSFSmap].

\midinsert \clabel[SYSFSmap]{Mapovani objektu a atributu v sysfs.}
\ctable{ll}{
 \hfil  Interni   & Externi  \crl \tskip4pt
        Kernelove objekty    & Slozky  \cr
        Atributy objektu     & Soubory  \cr
        Vazby mezi objekty   & Symbolicke odkazy  \cr
}
\caption/t  Tabulka prevzana z \cite[SYSFS].
\endinsert

V systemu muzeme videt tyto zarizeni v slozce /sys a muzeme tam napriklad videt tyto zarizeni ....

%/sys/
%|-- block
%|-- bus
%|-- class
%|-- devices
%|-- firmware
%|-- module
%‘-- power

\chap Prakticka cast

\secc vytvor

\secc hw

\secc zvolen RMII na misto MII

\secc sw

\secc testing

\secc results

\secc Otestujte implementované řešení zejména s ohledem na propustnost sítě a stabilitu

\chap Zaver

MII,RMII,GMII,RGMII,SGMII,QGMII,XAUI
